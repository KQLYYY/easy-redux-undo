"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=exports.GROUPEND=exports.GROUPBEGIN=exports.CLEAR=exports.REDO=exports.UNDO=void 0;var _toolkit=require("@reduxjs/toolkit"),_lodash=require("lodash");function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _iterableToArray(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a))return _arrayLikeToArray(a)}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}var _=require("lodash"),diff=require("deep-diff").diff,WRAPKEY="__wrapper",DEBUGPREPEND="[easy-redux-undo]=>",LIBRARYPREFIX="@@easy-redux-undo/",UNDOACTION="".concat(LIBRARYPREFIX,"UNDO"),REDOACTION="".concat(LIBRARYPREFIX,"REDO"),CLEARACTION="".concat(LIBRARYPREFIX,"CLEAR"),GROUPBEGINACTION="".concat(LIBRARYPREFIX,"GROUPBEGIN"),GROUPENDACTION="".concat(LIBRARYPREFIX,"GROUPEND"),UNDO=(0,_toolkit.createAction)(UNDOACTION);exports.UNDO=UNDO;var REDO=(0,_toolkit.createAction)(REDOACTION);exports.REDO=REDO;var CLEAR=(0,_toolkit.createAction)(CLEARACTION);exports.CLEAR=CLEAR;var GROUPBEGIN=(0,_toolkit.createAction)(GROUPBEGINACTION);exports.GROUPBEGIN=GROUPBEGIN;var GROUPEND=(0,_toolkit.createAction)(GROUPENDACTION);exports.GROUPEND=GROUPEND;var defaultOptions={maxHistory:100,undoType:UNDOACTION,redoType:REDOACTION,clearType:CLEARACTION,groupBeginType:GROUPBEGINACTION,groupEndType:GROUPENDACTION,include:[],exclude:[]},undoable=function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(b=Object.assign(defaultOptions,b),0<b.include.length&&0<b.exclude.length)return void console.error("".concat(DEBUGPREPEND," cannot have both a 'include' and 'exclude' property, choose one or the other!"));var c=function(a,c,d){var g,h=3<arguments.length&&void 0!==arguments[3]?arguments[3]:void 0,l=4<arguments.length&&void 0!==arguments[4]?arguments[4]:void 0,m=5<arguments.length&&void 0!==arguments[5]?arguments[5]:void 0,n={},o=h||a,p=m||d,q=!1,r=o.length-1,s=o[r];if(e(s)===b.groupEndType){n=f(s);var t=r-1;for(t;0<=t&&e(o[t])!==b.groupBeginType;t--);if(0==t&&e(o[t])!==b.groupBeginType)throw"".concat(DEBUGPREPEND," did not find a closed group of actions to undo, did you forget to send a '").concat(b.groupBeginType,"' action?");s=[];for(var u=r-1;u>=t+1;u--)s.push(o[u]);r=t,q=!0}if(o=o.slice(0,r),g=l||_.cloneDeep(c),Array.isArray(g)&&(g["".concat(WRAPKEY)]=g),q)for(var i=0;i<s.length;i++)for(var j=0;j<e(s[i]).length;j++)diff.revertChange(g,!0,e(s[i])[j]);else for(var k=0;k<e(s).length;k++)diff.revertChange(g,!0,e(s)[k]);return g=Array.isArray(g)?g["".concat(WRAPKEY)]:g,p=q?[{lib:b.groupEndType,dev:n}].concat(_toConsumableArray(s),[{lib:b.groupBeginType}],_toConsumableArray(p)):[s].concat(_toConsumableArray(p)),{past:o,present:g,future:p}},d=function(a,c,d){var g,h=3<arguments.length&&void 0!==arguments[3]?arguments[3]:void 0,l=4<arguments.length&&void 0!==arguments[4]?arguments[4]:void 0,m=5<arguments.length&&void 0!==arguments[5]?arguments[5]:void 0,n={},o=h||a,p=m||d,q=!1,r=1,s=p[r-1];if(e(s)===b.groupEndType){n=f(s);var t=r;for(t;t<=p.length&&e(p[t])!==b.groupBeginType;t++);if(t===p.length-1&&e(p[t])!==b.groupBeginType)throw"".concat(DEBUGPREPEND," did not find a closed group of actions to redo, something must have went wrong!");s=[];for(var u=t-1;u>=r;u--)s.push(p[u]);r=t+1,q=!0}if(p=p.slice(r),g=l||_.cloneDeep(c),Array.isArray(g)&&(g["".concat(WRAPKEY)]=g),q)for(var i=0;i<s.length;i++)for(var j=0;j<e(s[i]).length;j++)diff.applyChange(g,!0,e(s[i])[j]);else for(var k=0;k<e(s).length;k++)diff.applyChange(g,!0,e(s)[k]);return g=Array.isArray(g)?g["".concat(WRAPKEY)]:g,o=q?[].concat(_toConsumableArray(o),[{lib:b.groupBeginType}],_toConsumableArray(s),[{lib:b.groupEndType,dev:n}]):[].concat(_toConsumableArray(o),[s]),{past:o,present:g,future:p}},e=function(a){return a.lib},f=function(a){return a.dev};return function(){var f=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},g=1<arguments.length?arguments[1]:void 0,h=f.past,k=f.present,l=f.future;if("undefined"==typeof k)return{past:[],present:a(void 0,{}),future:[]};var m="number"==typeof g.payload&&0<g.payload?g.payload:1;switch(g.type){case b.groupBeginType:return{past:[].concat(_toConsumableArray(h),[{lib:b.groupBeginType,dev:b.groupBeginType}]),present:k,future:l};case b.groupEndType:if(h[h.length-1]===b.groupBeginType){console.warn("".concat(DEBUGPREPEND," did not add '").concat(b.groupEndType,"' action; detected that the previous action was '").concat(b.groupBeginType,"' - this would result in an empty group!"));break}else{var n=g.payload||"empty payload",o=[].concat(_toConsumableArray(h),[{lib:b.groupEndType,dev:n}]);return{past:o,present:k,future:l}}case b.clearType:return{past:[],present:k,future:[]};case b.undoType:{if(0===h.length)return{past:h,present:k,future:l};for(var p={},q=1;q<=m&&(p=c(h,k,l,p.past,p.present,p.future),0!==p.past.length);q++);return p}case b.redoType:{if(0===l.length)return{past:h,present:k,future:l};for(var r={},s=1;s<=m&&(r=d(h,k,l,r.past,r.present,r.future),0!==r.past.length);s++);return r}default:{var t,u=a(k,g);if(Array.isArray(u)?t=diff({WRAPKEY:k},{WRAPKEY:u}):"object"===_typeof(u)&&(t=diff(k,u)),"undefined"==typeof t)return f;for(var v=0,w=!1,x=_objectSpread({ts:Date.now()},g.historyPayload),y=[{lib:t,dev:x}],z={lib:t,dev:x},A=h.length-1;0<=A&&e(h[A])!==b.groupEndType;A--)if(e(h[A])===b.groupBeginType){w=!0;break}if(!w&&(0<b.include.length&&!b.include.includes(g.type.slice(g.type.indexOf("/")))||0<b.exclude.length&&b.exclude.includes(g.type)))return{past:h,present:u,future:l};for(var B=h.length-1;0<=B;B--)if(e(h[B])===b.groupEndType?(++v,w=!0):e(h[B])===b.groupBeginType?w=!1:!w&&++v,v>=b.maxHistory-1||0===B){if(e(h[B])===b.groupEndType){var C=B;for(C;0<=C&&e(h[C])!==b.groupBeginType;C--);y=[].concat(_toConsumableArray(h.slice(C)),[z])}else y=[].concat(_toConsumableArray(h.slice(B)),[z]);break}return{past:y,present:u,future:[]}}}}},_default=undoable;exports["default"]=_default;